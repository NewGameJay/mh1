$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://mh1.ai/schemas/module.schema.yaml"
title: Module Schema
description: |
  Schema for MH1 workflow modules. A module represents a discrete unit of work
  that can be planned, reviewed, approved, and executed. Modules track the full
  lifecycle from initial request through completion.

type: object
required:
  - module_id
  - client_id
  - name
  - status
  - created_at

properties:
  module_id:
    type: string
    pattern: "^mod_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    description: |
      Unique identifier for the module with mod_ prefix.
    examples:
      - "mod_550e8400-e29b-41d4-a716-446655440000"

  client_id:
    type: string
    pattern: "^cli_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    description: Foreign key reference to the client this module belongs to.

  name:
    type: string
    minLength: 1
    maxLength: 255
    description: |
      Human-readable name for the module. Describes the work being performed.
    examples:
      - "Q1 Lifecycle Audit"
      - "Email Welcome Series"
      - "Churn Prevention Campaign"

  template_id:
    type: string
    description: |
      Reference to the workflow template this module is based on.
      Can be null for ad-hoc modules.
    examples:
      - "lifecycle-audit"
      - "content-production"

  status:
    type: string
    enum:
      - DRAFT
      - PENDING_REVIEW
      - APPROVED
      - RUNNING
      - COMPLETED
      - FAILED
      - ABORTED
      - ARCHIVED
    default: DRAFT
    description: |
      Current status in the module lifecycle:
      - DRAFT: Initial creation, being configured.
      - PENDING_REVIEW: AI plan generated, awaiting human approval.
      - APPROVED: Human approved, ready to execute.
      - RUNNING: Currently executing.
      - COMPLETED: Successfully finished.
      - FAILED: Execution failed with errors.
      - ABORTED: Manually stopped by user.
      - ARCHIVED: Historical, no longer active.

  created_at:
    type: string
    format: date-time
    description: ISO 8601 timestamp when the module was created.

  updated_at:
    type: string
    format: date-time
    description: ISO 8601 timestamp when the module was last updated.

  meta:
    type: object
    description: |
      Planning metadata generated by AI and refined through review.
      Represents the "contract" between AI and human for what will be done.
    properties:
      task_description:
        type: string
        description: |
          Original task description provided by the user.
        examples:
          - "Audit the lifecycle marketing for Acme Corp"

      interpreted_task:
        type: string
        description: |
          AI's interpretation of what the task means and what will be delivered.
        examples:
          - "I will analyze Acme Corp's customer lifecycle stages, identify gaps in their email sequences, and provide recommendations for improving retention."

      assumptions:
        type: array
        items:
          type: string
        minItems: 0
        description: |
          Explicit assumptions the AI is making about the task.
          These should be validated during review.
        examples:
          - ["HubSpot is the primary CRM", "Focus is on B2B customers", "Budget data is available in Snowflake"]

      proposed_outputs:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
              description: Output file or artifact name.
            type:
              type: string
              enum:
                - markdown
                - json
                - csv
                - pdf
                - html
                - image
              description: Output format type.
            description:
              type: string
              description: What this output contains.
          required:
            - name
            - type
        description: |
          List of outputs that will be produced by this module.

      skills_to_run:
        type: array
        items:
          $ref: "#/$defs/SkillPlan"
        description: |
          Ordered list of skills that will be executed.

      required_inputs:
        type: array
        items:
          $ref: "#/$defs/InputRequirement"
        description: |
          Inputs needed before execution can begin.

      risk_flags:
        type: array
        items:
          type: string
        description: |
          Potential risks or concerns identified during planning.
        examples:
          - ["Large dataset may exceed context limits", "Missing email engagement data"]

    additionalProperties: true

  inputs:
    type: object
    description: Input files and parameters for module execution.
    properties:
      files:
        type: array
        items:
          $ref: "#/$defs/InputFile"
        description: Input files provided for the module.

      parameters:
        type: object
        additionalProperties: true
        description: |
          Key-value parameters for module configuration.
        examples:
          - date_range: "2024-01-01/2024-03-31"
            segment: "enterprise"
            include_churned: true

    additionalProperties: true

  outputs:
    type: object
    description: Output files and references produced by the module.
    properties:
      files:
        type: array
        items:
          $ref: "#/$defs/OutputFile"
        description: Output files produced by the module.

      firebase_refs:
        type: array
        items:
          type: object
          properties:
            collection:
              type: string
              description: Firebase collection name.
            document_id:
              type: string
              description: Firebase document ID.
            path:
              type: string
              description: Full Firebase path.
          required:
            - path
        description: References to data stored in Firebase.

    additionalProperties: true

  execution:
    type: object
    description: Execution state and history.
    properties:
      current_run_id:
        type: string
        pattern: "^run_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
        description: ID of the currently active or most recent run.

      runs:
        type: array
        items:
          type: object
          properties:
            run_id:
              type: string
              pattern: "^run_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            started_at:
              type: string
              format: date-time
            completed_at:
              type: string
              format: date-time
            status:
              type: string
              enum:
                - RUNNING
                - COMPLETED
                - FAILED
                - ABORTED
            triggered_by:
              type: string
              description: User or system that triggered this run.
          required:
            - run_id
            - started_at
            - status
        description: History of all runs for this module.

    additionalProperties: true

$defs:
  SkillPlan:
    type: object
    description: Planned skill execution within a module.
    required:
      - skill_name
      - purpose
    properties:
      skill_name:
        type: string
        description: Name of the skill to execute.
        examples:
          - "lifecycle-audit"
          - "hubspot-extract"
      purpose:
        type: string
        description: Why this skill is being run.
      estimated_tokens:
        type: integer
        minimum: 0
        description: Estimated token usage for this skill.
      dependencies:
        type: array
        items:
          type: string
        description: Skills that must complete before this one.
      parameters:
        type: object
        additionalProperties: true
        description: Parameters to pass to the skill.

  InputRequirement:
    type: object
    description: Required input for module execution.
    required:
      - name
      - type
      - required
    properties:
      name:
        type: string
        description: Input parameter name.
      type:
        type: string
        enum:
          - file
          - parameter
          - credential
          - api_access
        description: Type of input required.
      required:
        type: boolean
        description: Whether this input is mandatory.
      description:
        type: string
        description: What this input is used for.
      provided:
        type: boolean
        default: false
        description: Whether this input has been provided.

  InputFile:
    type: object
    description: Input file for module execution.
    required:
      - name
      - path
    properties:
      name:
        type: string
        description: Logical name for the file.
      path:
        type: string
        description: File path (relative to client directory or absolute).
      type:
        type: string
        description: File type/format.
      size_bytes:
        type: integer
        minimum: 0
        description: File size in bytes.
      checksum:
        type: string
        description: SHA-256 checksum for integrity verification.
      uploaded_at:
        type: string
        format: date-time
        description: When the file was uploaded.

  OutputFile:
    type: object
    description: Output file produced by module execution.
    required:
      - name
      - path
      - created_at
    properties:
      name:
        type: string
        description: Logical name for the output.
      path:
        type: string
        description: File path where output is stored.
      type:
        type: string
        enum:
          - markdown
          - json
          - csv
          - pdf
          - html
          - image
        description: Output format type.
      size_bytes:
        type: integer
        minimum: 0
        description: File size in bytes.
      checksum:
        type: string
        description: SHA-256 checksum for integrity verification.
      created_at:
        type: string
        format: date-time
        description: When the output was created.
      skill_name:
        type: string
        description: Skill that produced this output.

additionalProperties: false
