$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://mh1.ai/schemas/observability.schema.yaml"
title: Observability Schema
description: |
  Schema for MH1 observability components including structured logging,
  health panels, and history views. Provides consistent formats for
  monitoring, debugging, and operational visibility.

type: object
properties:
  structured_log:
    $ref: "#/$defs/StructuredLog"
  health_panel:
    $ref: "#/$defs/HealthPanel"
  history_view:
    $ref: "#/$defs/HistoryView"

$defs:
  StructuredLog:
    type: object
    description: |
      Structured log entry format. All logs should follow this schema
      for consistent parsing, filtering, and analysis.
    required:
      - log_id
      - timestamp
      - level
      - event_type
      - message
    properties:
      log_id:
        type: string
        pattern: "^log_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
        description: Unique identifier for the log entry.

      timestamp:
        type: string
        format: date-time
        description: ISO 8601 timestamp when the log was created.

      level:
        type: string
        enum:
          - DEBUG
          - INFO
          - WARN
          - ERROR
          - FATAL
        description: |
          Log severity level:
          - DEBUG: Detailed debugging information.
          - INFO: General operational information.
          - WARN: Warning conditions that should be noted.
          - ERROR: Error conditions that need attention.
          - FATAL: Critical errors causing system failure.

      context:
        type: object
        description: Contextual information for the log entry.
        properties:
          run_id:
            type: string
            pattern: "^run_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            description: Associated run ID.

          module_id:
            type: string
            pattern: "^mod_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            description: Associated module ID.

          client_id:
            type: string
            pattern: "^cli_[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            description: Associated client ID.

          skill_name:
            type: string
            description: Skill that generated this log.

          user_id:
            type: string
            description: User associated with this action.

          request_id:
            type: string
            description: External request ID for tracing.

          trace_id:
            type: string
            description: Distributed trace ID.

          span_id:
            type: string
            description: Span ID within a trace.

        additionalProperties: true

      event_type:
        type: string
        enum:
          - SKILL_START
          - SKILL_COMPLETE
          - SKILL_ERROR
          - RUN_START
          - RUN_COMPLETE
          - RUN_ERROR
          - API_CALL
          - API_RESPONSE
          - API_ERROR
          - VALIDATION_PASS
          - VALIDATION_FAIL
          - CHECKPOINT_SAVE
          - CHECKPOINT_RESTORE
          - CONTEXT_OFFLOAD
          - RATE_LIMIT_HIT
          - CACHE_HIT
          - CACHE_MISS
          - USER_ACTION
          - SYSTEM_EVENT
          - METRIC
        description: |
          Type of event being logged. Used for filtering and aggregation.

      message:
        type: string
        maxLength: 10000
        description: Human-readable log message.

      data:
        type: object
        description: Additional structured data for the log entry.
        properties:
          tokens:
            type: object
            properties:
              input:
                type: integer
              output:
                type: integer
              total:
                type: integer

          duration_ms:
            type: integer
            minimum: 0
            description: Operation duration in milliseconds.

          model:
            type: string
            description: AI model used.

          api_provider:
            type: string
            description: External API provider.

          status_code:
            type: integer
            description: HTTP status code (for API calls).

          error:
            type: object
            properties:
              class:
                type: string
              message:
                type: string
              stack:
                type: string

          metrics:
            type: object
            additionalProperties:
              type: number
            description: Numeric metrics associated with this log.

        additionalProperties: true

      tags:
        type: array
        items:
          type: string
        description: |
          Tags for categorization and filtering.
        examples:
          - ["production", "high-priority", "lifecycle"]

      source:
        type: object
        description: Source information for debugging.
        properties:
          file:
            type: string
            description: Source file path.
          line:
            type: integer
            description: Line number.
          function:
            type: string
            description: Function or method name.
          component:
            type: string
            description: System component (e.g., "runner", "skill", "api").

  HealthPanel:
    type: object
    description: |
      Health panel data for the observability dashboard. Provides
      real-time status of all system components and connections.
    required:
      - timestamp
      - connections
      - usage
    properties:
      timestamp:
        type: string
        format: date-time
        description: When this health snapshot was taken.

      overall_status:
        type: string
        enum:
          - HEALTHY
          - DEGRADED
          - UNHEALTHY
        description: |
          Overall system health:
          - HEALTHY: All systems operational.
          - DEGRADED: Some issues but functional.
          - UNHEALTHY: Critical issues affecting operations.

      connections:
        type: object
        description: Status of external connections.
        properties:
          mcp_servers:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                  description: MCP server name.
                status:
                  type: string
                  enum:
                    - CONNECTED
                    - DISCONNECTED
                    - ERROR
                    - INITIALIZING
                last_ping:
                  type: string
                  format: date-time
                latency_ms:
                  type: integer
                  minimum: 0
                error_message:
                  type: string
              required:
                - name
                - status

          databases:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                  description: Database name.
                type:
                  type: string
                  enum:
                    - snowflake
                    - bigquery
                    - postgresql
                    - firebase
                status:
                  type: string
                  enum:
                    - CONNECTED
                    - DISCONNECTED
                    - ERROR
                last_query:
                  type: string
                  format: date-time
                error_message:
                  type: string
              required:
                - name
                - type
                - status

          apis:
            type: array
            items:
              type: object
              properties:
                name:
                  type: string
                  description: API name (e.g., "HubSpot", "Anthropic").
                status:
                  type: string
                  enum:
                    - AVAILABLE
                    - DEGRADED
                    - UNAVAILABLE
                    - RATE_LIMITED
                last_call:
                  type: string
                  format: date-time
                rate_limit_remaining:
                  type: integer
                rate_limit_reset:
                  type: string
                  format: date-time
                error_message:
                  type: string
              required:
                - name
                - status

      usage:
        type: object
        description: Usage statistics for the current period.
        properties:
          period:
            type: string
            description: Usage period (e.g., "2024-01", "today").

          tokens:
            type: object
            properties:
              used:
                type: integer
                minimum: 0
                description: Tokens used in this period.
              limit:
                type: integer
                minimum: 0
                description: Token limit for this period.
              percentage:
                type: number
                minimum: 0
                maximum: 100
                description: Percentage of limit used.

          api_calls:
            type: object
            properties:
              total:
                type: integer
                minimum: 0
              by_provider:
                type: object
                additionalProperties:
                  type: integer

          runs:
            type: object
            properties:
              total:
                type: integer
                minimum: 0
              completed:
                type: integer
                minimum: 0
              failed:
                type: integer
                minimum: 0
              running:
                type: integer
                minimum: 0

          cost:
            type: object
            properties:
              estimated_usd:
                type: number
                minimum: 0
              budget_usd:
                type: number
                minimum: 0
              percentage:
                type: number
                minimum: 0
                maximum: 100

      recent_activity:
        type: array
        items:
          type: object
          properties:
            timestamp:
              type: string
              format: date-time
            event_type:
              type: string
            summary:
              type: string
            status:
              type: string
              enum:
                - SUCCESS
                - WARNING
                - ERROR
            client_id:
              type: string
            module_id:
              type: string
          required:
            - timestamp
            - event_type
            - summary
        maxItems: 50
        description: |
          Recent activity feed for the dashboard. Limited to most recent 50 events.

      alerts:
        type: array
        items:
          type: object
          properties:
            alert_id:
              type: string
            severity:
              type: string
              enum:
                - INFO
                - WARNING
                - CRITICAL
            title:
              type: string
            message:
              type: string
            created_at:
              type: string
              format: date-time
            acknowledged:
              type: boolean
              default: false
            acknowledged_by:
              type: string
          required:
            - alert_id
            - severity
            - title
            - message
            - created_at
        description: Active alerts requiring attention.

  HistoryView:
    type: object
    description: |
      Configuration and data for the history view. Allows users to
      browse, filter, and analyze past runs and operations.
    required:
      - filters
      - columns
      - results
    properties:
      filters:
        type: object
        description: Active filters for the history view.
        properties:
          client_id:
            type: string
            description: Filter by client.

          module_id:
            type: string
            description: Filter by module.

          status:
            type: array
            items:
              type: string
              enum:
                - RUNNING
                - COMPLETED
                - FAILED
                - ABORTED
            description: Filter by status.

          date_range:
            type: object
            properties:
              start:
                type: string
                format: date-time
              end:
                type: string
                format: date-time
            description: Filter by date range.

          skill_name:
            type: string
            description: Filter by skill.

          triggered_by:
            type: string
            description: Filter by user/system that triggered.

          min_duration_ms:
            type: integer
            minimum: 0
            description: Minimum duration filter.

          max_duration_ms:
            type: integer
            minimum: 0
            description: Maximum duration filter.

          has_errors:
            type: boolean
            description: Filter to runs with errors.

          search:
            type: string
            description: Free-text search query.

        additionalProperties: true

      columns:
        type: array
        items:
          type: object
          properties:
            key:
              type: string
              description: Column identifier.
            label:
              type: string
              description: Display label.
            visible:
              type: boolean
              default: true
            sortable:
              type: boolean
              default: true
            width:
              type: string
              description: Column width (e.g., "120px", "auto").
          required:
            - key
            - label
        description: Column configuration for the table view.

      sort:
        type: object
        properties:
          column:
            type: string
            description: Column to sort by.
          direction:
            type: string
            enum:
              - asc
              - desc
        description: Current sort configuration.

      pagination:
        type: object
        properties:
          page:
            type: integer
            minimum: 1
            default: 1
          page_size:
            type: integer
            minimum: 1
            maximum: 100
            default: 25
          total_items:
            type: integer
            minimum: 0
          total_pages:
            type: integer
            minimum: 0
        description: Pagination configuration.

      results:
        type: array
        items:
          type: object
          properties:
            run_id:
              type: string
            module_id:
              type: string
            client_id:
              type: string
            client_name:
              type: string
            module_name:
              type: string
            status:
              type: string
            started_at:
              type: string
              format: date-time
            completed_at:
              type: string
              format: date-time
            duration_ms:
              type: integer
            tokens_used:
              type: integer
            cost_usd:
              type: number
            triggered_by:
              type: string
            skills_run:
              type: array
              items:
                type: string
            error_count:
              type: integer
          required:
            - run_id
            - status
            - started_at
        description: Query results matching the current filters.

      actions:
        type: array
        items:
          type: object
          properties:
            action_id:
              type: string
              description: Action identifier.
            label:
              type: string
              description: Display label.
            icon:
              type: string
              description: Icon name.
            enabled:
              type: boolean
              default: true
            requires_selection:
              type: boolean
              default: false
              description: Whether this action requires selected rows.
            confirmation_required:
              type: boolean
              default: false
              description: Whether this action needs confirmation.
          required:
            - action_id
            - label
        description: |
          Available actions for the history view.
        examples:
          - - action_id: "view_details"
              label: "View Details"
              icon: "eye"
              requires_selection: true
            - action_id: "rerun"
              label: "Rerun"
              icon: "refresh"
              requires_selection: true
              confirmation_required: true
            - action_id: "export"
              label: "Export CSV"
              icon: "download"

additionalProperties: true
