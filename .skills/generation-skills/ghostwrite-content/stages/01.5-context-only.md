# Stage 1.5: Context-Only Mode

**Duration**: 2-3 minutes
**Conditional**: Only executes when `--context-only` flag is set
**Exit Point**: Workflow exits after this stage in context-only mode

## Purpose

Generate comprehensive context window files showing exactly what each component "sees" in the pipeline. This mode is useful for:
- Debugging context quality and isolation
- Validating data flow between agents
- Verifying context reduction (~40K -> ~15K tokens for ghostwriter)
- Reviewing available data before generation

## Client Info (from active_client.md)

```
CLIENT_ID = {parsed from inputs/active_client.md}
CLIENT_NAME = {parsed from inputs/active_client.md}
FOLDER_NAME = {parsed from inputs/active_client.md}
```

## Behavior

When `--context-only` flag is set:
1. Orchestrator outputs its context file (all data loaded in Stage 1)
2. Agents still execute (topic selection, template matching) but output context files
3. Ghostwriter outputs context file but does NOT generate posts
4. Stages 4-6 (QA, Calendar, Presentation) are SKIPPED

## Context Files Generated

| File | Agent/Stage | Description |
|------|-------------|-------------|
| `00-ORCHESTRATOR_CONTEXT_{TIMESTAMP}.md` | Orchestrator | All data loaded by command (master context) |
| `01-TOPIC_CURATOR_CONTEXT_{TIMESTAMP}.md` | linkedin-topic-curator | Thought leaders, events, social posts, moderate context |
| `02-TEMPLATE_SELECTOR_CONTEXT_{TIMESTAMP}.md` | linkedin-template-selector | Selected topics, template database, full client context |
| `03-GHOSTWRITER_CONTEXT_{TIMESTAMP}.md` | linkedin-ghostwriter | Template selections, topic summaries, founder voice, full context |

---

## Step 1.5.0: Create Output Directory

```bash
mkdir -p {FOLDER_NAME}/context-snapshots/
```

## Step 1.5.1: Generate Timestamp

Generate timestamp for filenames with format `YYYYMMDD_HHMMSS`:
- Example: `20260104_103000`
- Use local time
- Store as `{TIMESTAMP}` variable for all context files

---

## Step 1.5.2: Generate Orchestrator Context File

**File**: `{FOLDER_NAME}/context-snapshots/00-ORCHESTRATOR_CONTEXT_{TIMESTAMP}.md`

Use template from `templates/context-snapshot.md` with sections:

### Header
```markdown
# Orchestrator Context Window

**Generated**: {ISO timestamp}
**Client ID**: {CLIENT_ID}
**Client Name**: MH-1
**Founder ID**: {FOUNDER_ID}
**Founder Name**: {FOUNDER_NAME}
**Platform**: {--platform}
**Post Count Requested**: {--post-count}
**Min Relevance Filter**: {--min-relevance}
**Max Source Posts**: {--max-source-posts}
**Context-Only Mode**: true
```

### Section 1: Social Listening Posts
- Source: `fetch_source_posts.py`
- Posts Loaded: {count}
- Relevance Range: {min} to {max}
- Raw Data: Full JSON dump of source_posts.json

### Section 2: Thought Leader Posts
- Source: `fetch_thought_leader_posts.py`
- Leaders Loaded: {count}
- Total Posts: {count}
- Raw Data: Full JSON dump of thought_leader_posts.json

### Section 3: Parallel Events
- Source: `fetch_parallel_events.py`
- Events Loaded: {count}
- Date Range: Last 14 days
- Raw Data: Full JSON dump of parallel_events.json

### Section 4: Client Context (Firestore)
- 4.1 Brand Context - Full JSON dump
- 4.2 Messaging Context - Full JSON dump
- 4.3 Audience Context - Full JSON dump
- 4.4 Strategy Context - Full JSON dump
- 4.5 Competitive Context - Full JSON dump

### Section 5: Founder Voice Data
- 5.1 Founder Profile - Full JSON dump
- 5.2 Founder Posts - Full JSON array

### Section 6: Case Studies
- List .md files with sizes (if available)
- Full content of each file
- Or "No case studies available"

### Section 7: Data Distribution Summary
Table showing what data goes to each agent:

| Data Type | Count | Passed To |
|-----------|-------|-----------|
| Social Listening Posts | {n} | Topic Curator |
| Thought Leader Posts | {n} | Topic Curator |
| Parallel Events | {n} | Topic Curator |
| Client Context (docs) | 5 | Topic Curator (moderate), Template Selector (full), Ghostwriter (full) |
| Founder Profile | 1 | Topic Curator (topThemes only), Ghostwriter (full) |
| Founder Posts | {n} | Ghostwriter only |
| Case Studies | {n} | Ghostwriter only |

---

## Step 1.5.3: Continue with Agent Invocations

After generating orchestrator context, **continue to Stages 1.75, 2, and 3** with `--context-only` flag passed to each agent.

**Important**: Do NOT exit at Stage 1.5. Agents need to run:
1. **Topic Curator**: Outputs context file AND performs topic selection (needed for template selector)
2. **Template Selector**: Outputs context file AND performs template matching (needed for ghostwriter)
3. **Ghostwriter**: Outputs context file but does NOT generate posts

### Agent Prompt Modifications

**Stage 1.75 (Topic Curator)**:
Add to prompt: `Context-only mode: output context file to {FOLDER_NAME}/context-snapshots/01-TOPIC_CURATOR_CONTEXT_{TIMESTAMP}.md`

**Stage 2 (Template Selector)**:
Add to prompt: `Context-only mode: output context file to {FOLDER_NAME}/context-snapshots/02-TEMPLATE_SELECTOR_CONTEXT_{TIMESTAMP}.md`

**Stage 3 (Ghostwriter)**:
Add to prompt: `Context-only mode: output context file to {FOLDER_NAME}/context-snapshots/03-GHOSTWRITER_CONTEXT_{TIMESTAMP}.md, do NOT generate posts.`

---

## Step 1.5.4: Skip Post-Processing Stages

After Stage 3 completes in context-only mode:
- **SKIP Stage 4** (QA Review) - no posts to review
- **SKIP Stage 5** (Calendar Compilation) - no posts to compile
- **SKIP Stage 6** (Final Presentation) - use context-only completion message instead

---

## Step 1.5.5: Completion Message

Display completion summary:

```markdown
## Context Window Analysis Complete

**Client**: {CLIENT_NAME}
**Founder**: {FOUNDER_NAME}
**Timestamp**: {TIMESTAMP}
**Mode**: --context-only (agents ran, no posts generated)

### Context Files Generated

| File | Agent/Stage | Description |
|------|-------------|-------------|
| 00-ORCHESTRATOR_CONTEXT_{TIMESTAMP}.md | Orchestrator | All data loaded by command (master context) |
| 01-TOPIC_CURATOR_CONTEXT_{TIMESTAMP}.md | linkedin-topic-curator | Thought leaders, events, social posts, moderate company context |
| 02-TEMPLATE_SELECTOR_CONTEXT_{TIMESTAMP}.md | linkedin-template-selector | Selected topics, template database, full client context |
| 03-GHOSTWRITER_CONTEXT_{TIMESTAMP}.md | linkedin-ghostwriter | Template selections, topic summaries, founder voice, full context |

**Location**: `{FOLDER_NAME}/context-snapshots/`

### Context Isolation Verification

| Agent | External Posts Received | Company Context | Founder Data |
|-------|------------------------|-----------------|--------------|
| Topic Curator | {n} TL + {n} events + {n} social | Moderate (4 fields) | topThemes only |
| Template Selector | None (topics only) | Full (5 docs) | None |
| Ghostwriter | None (inspirationSummary only) | Full (5 docs) | Full (profile + {n} posts) |

### Token Reduction Achieved

- **Without isolation**: ~40K tokens (all external posts to ghostwriter)
- **With isolation**: ~15K tokens (only summaries to ghostwriter)
- **Reduction**: ~60%

### Workflow Results

- **Topics Selected**: {n} topics ({sum} posts allocated)
- **Templates Matched**: {n} template selections
- **Posts Generated**: 0 (context-only mode)

### Next Steps

1. Review context files in `{FOLDER_NAME}/context-snapshots/`
2. Verify each agent received appropriate context
3. Check that ghostwriter context has topic summaries (not raw posts)
4. If context looks complete, run without --context-only:
   `/ghostwrite-content "{FOUNDER_NAME}"`
```

---

## Quality Gate (Context-Only Mode)

- [ ] 00-ORCHESTRATOR_CONTEXT_{TIMESTAMP}.md generated
- [ ] 01-TOPIC_CURATOR_CONTEXT_{TIMESTAMP}.md generated (by agent)
- [ ] 02-TEMPLATE_SELECTOR_CONTEXT_{TIMESTAMP}.md generated (by agent)
- [ ] 03-GHOSTWRITER_CONTEXT_{TIMESTAMP}.md generated (by agent)
- [ ] selectedTopics returned from topic curator
- [ ] Template selections returned from template selector
- [ ] No posts generated (ghostwriter skipped generation)
- [ ] Context-only completion message displayed

**EXIT WORKFLOW after displaying completion message.**
