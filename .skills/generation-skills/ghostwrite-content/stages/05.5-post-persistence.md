# Stage 5.5: Post Persistence

**Duration**: 30-60 seconds
**Blocking**: Yes - Stage 6 waits for completion

## Purpose

Upload generated posts to Firestore at `clients/{CLIENT_ID}/posts/` with bi-directional references to contentCalendar. This enables:
- Publishing workflow (status tracking, scheduling)
- Engagement tracking (post-publish metrics sync)
- Cross-campaign analytics (template performance, voice consistency)
- Content repurposing (find/adapt best performers)

## Client Info (from active_client.md)

```
CLIENT_ID = {parsed from inputs/active_client.md}
CLIENT_NAME = {parsed from inputs/active_client.md}
FOLDER_NAME = {parsed from inputs/active_client.md}
```

## Prerequisites

- Stage 5 complete: CONTENT_CALENDAR_FINAL.json created
- CALENDAR_RUN_ID available (from Stage 1.75)

## Inputs

| Input | Source | Description |
|-------|--------|-------------|
| `CONTENT_CALENDAR_FINAL.json` | Stage 5 | Structured calendar with all posts |
| `CLIENT_ID` | Hardcoded | `{CLIENT_ID}` |
| `CALENDAR_RUN_ID` | Stage 1.75 | contentCalendar document ID |

## Outputs

| Output | Type | Description |
|--------|------|-------------|
| Firestore posts | Database | 20-30 post documents in clients/{CLIENT_ID}/posts/ |
| contentCalendar update | Database | postIds array added to calendar doc |
| Upload status | JSON | Success/failure for error handling |

---

## Task 1: Invoke Upload Script

Call `upload_generated_posts.py` with calendar JSON path:

```bash
python skills/firebase-bulk-upload/upload_generated_posts.py \
  "{CAMPAIGN_DIR}/CONTENT_CALENDAR_FINAL.json" \
  "{CLIENT_ID}" \
  "{CALENDAR_RUN_ID}" \
  2>&1
```

**CRITICAL**: Capture both stdout (JSON result) and stderr (logs).

**Script Arguments**:
- `calendar_json_file`: Path to CONTENT_CALENDAR_FINAL.json
- `client_id`: `{CLIENT_ID}` (hardcoded for MH-1)
- `calendar_run_id`: contentCalendar document ID (e.g., ghostwrite-linkedin-2026-01-22)
- `--dry-run`: Optional flag to preview without uploading

---

## Task 2: Parse Upload Results

Extract JSON from script output:

```bash
# Store output
UPLOAD_OUTPUT=$(python skills/firebase-bulk-upload/upload_generated_posts.py ...)

# Check for success
if echo "$UPLOAD_OUTPUT" | grep -q '"success": true'; then
  echo "Posts uploaded to Firestore"
else
  echo "Firestore upload failed"
  exit 1
fi
```

Parse key metrics:
- `postsUploaded`: Should match post count from Stage 5
- `postIds`: Array of created document IDs
- `calendarUpdated`: Confirms bi-directional reference created
- `errors`: Number of errors (should be 0)
- `errorMessages`: Array of error details (if any)

**Expected Success Output**:
```json
{
  "success": true,
  "postsUploaded": 20,
  "postIds": [
    "ghostwrite-linkedin-2026-01-22-001",
    "ghostwrite-linkedin-2026-01-22-002",
    "...",
    "ghostwrite-linkedin-2026-01-22-020"
  ],
  "calendarUpdated": true,
  "errors": 0,
  "errorMessages": [],
  "platform": "linkedin",
  "clientId": "{CLIENT_ID}",
  "calendarRunId": "ghostwrite-linkedin-2026-01-22",
  "firestorePath": "clients/{CLIENT_ID}/posts"
}
```

---

## Task 3: Update Checkpoint

Mark Stage 5.5 complete:

```bash
python skills/ghostwrite-content/scripts/checkpoint.py \
  "{CAMPAIGN_DIR}" complete "5.5"
```

---

## Task 4: Error Handling

**If upload fails** (success: false or exit code 1):
1. Log error details to stderr
2. DO NOT proceed to Stage 6
3. Exit with code 1
4. Display error message:
   ```
   Failed to upload posts to Firestore

   Error: {error_message}

   Campaign files saved locally at:
   {CAMPAIGN_DIR}

   To retry Firestore upload manually:
   python skills/firebase-bulk-upload/upload_generated_posts.py \
     {CAMPAIGN_DIR}/CONTENT_CALENDAR_FINAL.json \
     {CLIENT_ID} \
     {CALENDAR_RUN_ID}
   ```

**If upload succeeds**:
- Log success message with post count and Firestore paths
- Proceed to Stage 6 (Final Presentation)
- Include Firestore paths in completion summary

---

## Quality Gate

- [ ] All posts uploaded (count matches Stage 5 output)
- [ ] contentCalendar updated with postIds array
- [ ] No Firestore errors
- [ ] Checkpoint updated to 5.5

---

## Firestore Schema Reference

### Post Document

**Path**: `clients/{CLIENT_ID}/posts/{postId}`

**Document ID Format**: `{calendarRunId}-{postNumber:03d}`
- Example: `ghostwrite-linkedin-2026-01-22-001`

**Fields**:
```json
{
  // Identity
  "postId": 1,
  "calendarRunId": "ghostwrite-linkedin-2026-01-22",
  "platform": "linkedin",

  // Content
  "content": "Full post text...",
  "contentLength": 1247,

  // Generation metadata
  "topicId": "topic-001",
  "topic": "Female Founder Funding Challenges",
  "templateId": 8,
  "templateName": "Industry hot take V2",
  "funnelStage": "TOFU",
  "angle": "Alternative funding paths",
  "voiceConfidence": 8.5,
  "qaStatus": "pass",

  // Scheduling
  "scheduledWeek": 1,
  "scheduledDate": "2026-01-06",
  "scheduledDay": "Monday",
  "scheduledTime": "09:00 AM ET",

  // Publishing lifecycle (defaults)
  "status": "draft",  // draft | scheduled | published | archived
  "publishedAt": null,
  "publishedUrl": null,

  // Engagement (empty, to be updated post-publish)
  "engagement": {
    "likes": 0,
    "comments": 0,
    "shares": 0,
    "impressions": 0,
    "lastSyncedAt": null
  },

  // Sourcing
  "sourceType": "thought-leader",
  "sourceRef": "thoughtLeaders/abc123",
  "inspirationSummary": "Discussion on funding challenges...",
  "relevanceScore": 7.8,

  // Timestamps
  "generatedAt": "2026-01-04T10:00:00Z",
  "createdAt": "2026-01-04T10:00:00Z",
  "updatedAt": "2026-01-04T10:00:00Z"
}
```

### contentCalendar Update

**Path**: `clients/{CLIENT_ID}/contentCalendar/{RUN_ID}`

**Added Fields**:
```json
{
  "postIds": [
    "ghostwrite-linkedin-2026-01-22-001",
    "ghostwrite-linkedin-2026-01-22-002",
    "...",
    "ghostwrite-linkedin-2026-01-22-020"
  ],
  "postsUploadedAt": "2026-01-22T15:30:00Z"
}
```

---

## Next Stage

-> [Stage 6: Final Presentation](./06-final-presentation.md)
