#!/usr/bin/env python3
"""
MH1 CLI - AI-First Marketing Operations

A branded wrapper around Claude Code. The UI is Python,
the intelligence is Claude Code with full native tools.
"""

import sys
import os
import subprocess
import json
from pathlib import Path

PROJECT_ROOT = Path(__file__).parent
sys.path.insert(0, str(PROJECT_ROOT))

from rich.console import Console
from rich.text import Text

import yaml
from dotenv import load_dotenv

load_dotenv()

# MH1 Brand Colors
C = {
    "pink": "#EC4899",
    "rose": "#F472B6",
    "orange": "#F97316",
    "amber": "#FBBF24",
    "yellow": "#FDE047",
    "white": "#FAFAFA",
    "gray": "#9CA3AF",
    "dim": "#4B5563",
    "green": "#22C55E",
    "red": "#EF4444",
    "cyan": "#06B6D4",
}

console = Console()

# ASCII Art Logo
LOGO = f"""[bold #EC4899]███╗[/][bold #F472B6]   [/][bold #F97316]███╗[/][bold #FBBF24]██╗[/][bold #FDE047]  ██╗[/]  [bold #EC4899]██╗[/]
[bold #EC4899]████╗[/][bold #F472B6] [/][bold #F97316]████║[/][bold #FBBF24]██║[/][bold #FDE047]  ██║[/]  [bold #F472B6]███║[/]
[bold #EC4899]██╔████╔██║[/][bold #FBBF24]███████║[/]  [bold #F97316]╚██║[/]
[bold #F472B6]██║[/][bold #F97316]╚██╔╝██║[/][bold #FBBF24]██╔══██║[/]   [bold #FBBF24]██║[/]
[bold #F97316]██║[/][bold #FBBF24] ╚═╝ [/][bold #FDE047]██║██║[/]  [bold #FDE047]██║[/]   [bold #FDE047]██║[/]
[bold #FBBF24]╚═╝[/]     [bold #FDE047]╚═╝╚═╝[/]  [bold #FDE047]╚═╝[/]   [bold #FDE047]╚═╝[/]"""

QUICK_ACTIONS = f"[{C['dim']}][[/][{C['yellow']}]1[/][{C['dim']}]] Skills  [[/][{C['yellow']}]2[/][{C['dim']}]] Agents  [[/][{C['yellow']}]3[/][{C['dim']}]] Client  [[/][{C['yellow']}]?[/][{C['dim']}]] Help  [[/][{C['yellow']}]q[/][{C['dim']}]] Quit[/]"


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# SCANNING
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

def scan_skills() -> list[dict]:
    skills = []
    for dirname in [".skills", "skills"]:
        skills_dir = PROJECT_ROOT / dirname
        if not skills_dir.exists():
            continue
        for category_dir in sorted(skills_dir.iterdir()):
            if not category_dir.is_dir() or category_dir.name.startswith("_"):
                continue
            for skill_dir in sorted(category_dir.iterdir()):
                if not skill_dir.is_dir() or skill_dir.name.startswith("_") or "TEMPLATE" in skill_dir.name:
                    continue
                skill_md = skill_dir / "SKILL.md"
                if not skill_md.exists():
                    continue
                try:
                    content = skill_md.read_text()
                    if content.startswith("---"):
                        parts = content.split("---", 2)
                        if len(parts) >= 3:
                            fm = yaml.safe_load(parts[1])
                            cat = category_dir.name.replace("-skills", "")
                            skills.append({
                                "name": fm.get("name", skill_dir.name),
                                "description": fm.get("description", "")[:100],
                                "category": cat,
                            })
                except:
                    continue
    return skills


def scan_agents() -> list[dict]:
    agents = []
    for dirname in [".agents", "agents"]:
        agents_dir = PROJECT_ROOT / dirname
        if not agents_dir.exists():
            continue
        for agent_type in ["orchestrators", "workers", "evaluators"]:
            type_dir = agents_dir / agent_type
            if not type_dir.exists():
                continue
            for f in sorted(type_dir.glob("*.md")):
                if f.name.startswith("_") or "TEMPLATE" in f.name:
                    continue
                try:
                    content = f.read_text()
                    name = f.stem.replace("-", " ").title()
                    desc = ""
                    for line in content.split("\n"):
                        if line.strip() and not line.startswith("#") and not line.startswith("---"):
                            desc = line.strip()[:60]
                            break
                    agents.append({"name": name, "type": agent_type.rstrip("s"), "description": desc})
                except:
                    continue
    return agents


def scan_clients() -> list[str]:
    clients_dir = PROJECT_ROOT / "clients"
    if not clients_dir.exists():
        return []
    return [d.name for d in sorted(clients_dir.iterdir()) if d.is_dir() and not d.name.startswith("_")]


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# SESSION
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

class Session:
    def __init__(self):
        self.client_name = None
        self.client_id = None

    def ensure_client_dir(self):
        if self.client_id:
            client_dir = PROJECT_ROOT / "clients" / self.client_id
            client_dir.mkdir(parents=True, exist_ok=True)


session = Session()


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# UI FUNCTIONS
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

def clear():
    os.system('cls' if os.name == 'nt' else 'clear')


def render_welcome():
    clear()
    console.print()
    console.print(LOGO)
    console.print()
    console.print(f"[{C['white']}]AI-powered marketing operations[/]")
    console.print(f"[{C['dim']}]Powered by Claude Code[/]")
    console.print()
    console.print(QUICK_ACTIONS)
    console.print()

    skills = scan_skills()
    agents = scan_agents()
    clients = scan_clients()

    status = Text()
    status.append("● ", style=C['green'])
    status.append(f"{len(skills)} skills", style=C['white'])
    status.append("  ", style=C['dim'])
    status.append(f"{len(agents)} agents", style=C['gray'])
    status.append("  ", style=C['dim'])
    status.append(f"{len(clients)} clients", style=C['gray'])
    console.print(status)

    if session.client_name:
        console.print(f"\n[{C['pink']}]◆[/] [{C['white']}]Client:[/] [{C['amber']}]{session.client_name}[/]")
    else:
        console.print(f"\n[{C['dim']}]◇ No client selected (use [bold]3[/bold] to switch)[/]")

    console.print()


def render_prompt() -> str:
    try:
        user_input = console.input(f"[{C['pink']}]>[/] ")
        return user_input.strip()
    except (KeyboardInterrupt, EOFError):
        return "q"


def show_help():
    clear()
    console.print()
    console.print(LOGO)
    console.print()
    help_text = f"""
[bold {C['pink']}]COMMANDS[/]
  [{C['yellow']}]1[/]      [{C['white']}]List skills by category[/]
  [{C['yellow']}]2[/]      [{C['white']}]List available agents[/]
  [{C['yellow']}]3[/]      [{C['white']}]Switch client[/]
  [{C['yellow']}]?[/]      [{C['white']}]Show this help[/]
  [{C['yellow']}]q[/]      [{C['white']}]Quit[/]

[bold {C['orange']}]HOW IT WORKS[/]
  [{C['gray']}]1. Select a client (press 3)[/]
  [{C['gray']}]2. Type what you need[/]
  [{C['gray']}]3. MH1 launches Claude Code with your request[/]

  [{C['white']}]Claude Code has full access to:[/]
  [{C['dim']}]• All MCP servers (Firestore, HubSpot, Firecrawl)[/]
  [{C['dim']}]• Read/write files, run commands[/]
  [{C['dim']}]• Execute skills from skills/[/]

[bold {C['amber']}]EXAMPLES[/]
  [{C['gray']}]"Run a lifecycle audit"[/]
  [{C['gray']}]"Onboard Acme Corp as a new client"[/]
  [{C['gray']}]"What skills help with churn?"[/]
"""
    console.print(help_text)
    input(f"\n  Press Enter to continue...")


def show_skills():
    clear()
    skills = scan_skills()
    by_cat = {}
    for s in skills:
        cat = s["category"]
        if cat not in by_cat:
            by_cat[cat] = []
        by_cat[cat].append(s)

    console.print(f"\n[bold {C['pink']}]SKILLS[/] [{C['gray']}]({len(skills)} total)[/]\n")
    for cat, items in sorted(by_cat.items()):
        console.print(f"[bold {C['orange']}]{cat.upper()}[/] [{C['dim']}]({len(items)})[/]")
        for s in items:
            console.print(f"  [{C['gray']}]•[/] [{C['white']}]{s['name']}[/]")
        console.print()
    input(f"  Press Enter to continue...")


def show_agents():
    clear()
    agents = scan_agents()
    console.print(f"\n[bold {C['pink']}]AGENTS[/] [{C['gray']}]({len(agents)} total)[/]\n")
    for t in ["orchestrator", "worker", "evaluator"]:
        typed = [a for a in agents if a["type"] == t]
        if typed:
            console.print(f"[bold {C['orange']}]{t.upper()}S[/]")
            for a in typed:
                console.print(f"  [{C['gray']}]•[/] [{C['white']}]{a['name']}[/]")
            console.print()
    input(f"  Press Enter to continue...")


def fetch_firebase_clients() -> tuple[list[dict], str]:
    """
    Fetch clients from Firebase via firestore-nav skill.
    Returns (clients_list, error_message).
    """
    skill_path = PROJECT_ROOT / "skills" / "operations-skills" / "firestore-nav" / "firestore-nav.js"
    if not skill_path.exists():
        return [], "firestore-nav skill not found"

    # Check if credentials are set
    if not os.environ.get("GOOGLE_APPLICATION_CREDENTIALS") and not os.environ.get("SERVICE_ACCOUNT_KEY_PATH"):
        return [], "Firebase credentials not configured"

    try:
        # Pass env with dotenv values
        env = os.environ.copy()
        result = subprocess.run(
            ["node", str(skill_path), "clients", "--fields", "name,displayName,status", "--limit", "50"],
            cwd=skill_path.parent,
            capture_output=True,
            text=True,
            timeout=15,
            env=env
        )
        if result.stdout:
            data = json.loads(result.stdout)
            if "error" in data:
                return [], data.get("message", "Unknown Firebase error")
            if "documents" in data:
                clients = []
                for doc in data["documents"]:
                    doc_data = doc.get("data", {})
                    clients.append({
                        "id": doc.get("id", ""),
                        "name": doc_data.get("displayName") or doc_data.get("name") or doc.get("id", ""),
                        "status": doc_data.get("status", ""),
                        "source": "firebase"
                    })
                return clients, ""
        return [], "No data returned"
    except subprocess.TimeoutExpired:
        return [], "Firebase request timed out"
    except json.JSONDecodeError:
        return [], "Invalid response from Firebase"
    except Exception as e:
        return [], str(e)


def get_merged_clients() -> tuple[list[dict], str]:
    """Get merged list of local + Firebase clients. Returns (clients, firebase_error)."""
    # Local clients
    local_clients = scan_clients()
    local_set = set(local_clients)

    # Firebase clients
    console.print(f"[{C['dim']}]Fetching from Firebase...[/]", end="")
    firebase_clients, firebase_error = fetch_firebase_clients()
    console.print(f"\r[{C['dim']}]                         [/]\r", end="")  # Clear line

    # Build merged list
    merged = []
    firebase_ids = set()

    for fb in firebase_clients:
        fb_id = fb["id"]
        firebase_ids.add(fb_id)
        is_local = fb_id in local_set
        merged.append({
            "id": fb_id,
            "name": fb["name"],
            "status": fb["status"],
            "source": "both" if is_local else "firebase"
        })

    # Add local-only clients
    for local_id in local_clients:
        if local_id not in firebase_ids:
            merged.append({
                "id": local_id,
                "name": local_id.replace("-", " ").title(),
                "status": "",
                "source": "local"
            })

    # Sort: active client first, then by name
    def sort_key(c):
        is_active = c["id"] == session.client_id
        return (not is_active, c["name"].lower())

    return sorted(merged, key=sort_key), firebase_error


def show_clients():
    clear()
    console.print(f"\n[bold {C['pink']}]CLIENTS[/]\n")

    clients, firebase_error = get_merged_clients()

    # Show Firebase status
    if firebase_error:
        console.print(f"[{C['dim']}]Firebase: {firebase_error}[/]")
        console.print(f"[{C['dim']}](Showing local clients only)[/]\n")

    if not clients:
        console.print(f"  [{C['dim']}]No clients found.[/]")
    else:
        for i, c in enumerate(clients, 1):
            is_active = c["id"] == session.client_id
            source = c["source"]
            status = c["status"]

            # Source indicator
            if source == "both":
                src_icon = f"[{C['green']}]◉[/]"  # Local + Firebase
            elif source == "firebase":
                src_icon = f"[{C['cyan']}]◎[/]"   # Firebase only
            else:
                src_icon = f"[{C['yellow']}]○[/]"  # Local only

            # Build line
            if is_active:
                line = f"  {src_icon} [{C['white']}]{i:2}. {c['name']}[/] [{C['green']}](active)[/]"
            else:
                line = f"  {src_icon} [{C['gray']}]{i:2}. {c['name']}[/]"

            # Add status if present
            if status and not is_active:
                line += f" [{C['dim']}]({status})[/]"

            console.print(line)

    console.print()
    console.print(f"[{C['dim']}]Legend: [{C['green']}]◉[/] local+firebase  [{C['cyan']}]◎[/] firebase  [{C['yellow']}]○[/] local only[/]")
    console.print(f"\n[{C['gray']}]Enter number to switch, or type a new client name:[/]")
    choice = input("  > ").strip()

    if choice.isdigit() and 1 <= int(choice) <= len(clients):
        selected = clients[int(choice) - 1]
        session.client_id = selected["id"]
        session.client_name = selected["name"]
        session.ensure_client_dir()
        console.print(f"\n  [{C['green']}]✓ Switched to {session.client_name}[/]")
    elif choice:
        session.client_id = choice.lower().replace(" ", "-")
        session.client_name = choice.title()
        session.ensure_client_dir()
        console.print(f"\n  [{C['green']}]✓ Set client: {session.client_name}[/]")
    input("  Press Enter to continue...")


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# CLAUDE CODE INTEGRATION
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

def check_claude_installed() -> bool:
    """Check if Claude Code CLI is available."""
    result = subprocess.run(["which", "claude"], capture_output=True, text=True)
    return result.returncode == 0


def run_claude(prompt: str = None):
    """
    Launch Claude Code with optional initial prompt.
    Claude Code takes over the terminal completely.
    """
    if not check_claude_installed():
        console.print(f"\n[{C['red']}]Claude Code not installed.[/]")
        console.print(f"\n[{C['white']}]Install it:[/]")
        console.print(f"  [{C['cyan']}]npm install -g @anthropic-ai/claude-code[/]")
        console.print()
        sys.exit(1)

    # Build context for Claude
    context_parts = []
    if session.client_id:
        context_parts.append(f"Current client: {session.client_name} (ID: {session.client_id})")
        context_parts.append(f"Client directory: clients/{session.client_id}/")

    context = "\n".join(context_parts) if context_parts else ""

    # Build command
    cmd = ["claude"]
    if prompt:
        full_prompt = prompt
        if context:
            full_prompt = f"[Context: {context}]\n\n{prompt}"
        cmd.append(full_prompt)

    # Hand off to Claude Code completely (replaces this process)
    os.execvp("claude", cmd)


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# MAIN
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

def main():
    # Direct command mode: ./mh1 "run lifecycle audit"
    if len(sys.argv) > 1:
        prompt = " ".join(sys.argv[1:])
        run_claude(prompt)  # This replaces the process, won't return
        return

    # Menu mode - select client, then hand off to Claude
    while True:
        render_welcome()
        user_input = render_prompt()

        if not user_input:
            continue

        cmd = user_input.lower()
        if cmd in ["q", "quit", "exit"]:
            console.print(f"\n[{C['green']}]Goodbye![/]\n")
            break
        elif cmd in ["?", "help"]:
            show_help()
        elif cmd in ["1", "s", "skills"]:
            show_skills()
        elif cmd in ["2", "a", "agents"]:
            show_agents()
        elif cmd in ["3", "c", "client", "clients"]:
            show_clients()
        else:
            # Hand off to Claude Code - this replaces the process
            run_claude(user_input)


if __name__ == "__main__":
    main()
